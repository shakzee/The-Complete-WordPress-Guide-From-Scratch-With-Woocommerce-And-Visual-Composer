!function(a,e,o,n){"use strict";a.fn.EVFBackboneModal=function(e){return this.each(function(){new a.EVFBackboneModal(a(this),e)})},a.EVFBackboneModal=function(e,t){var o=a.extend({},a.EVFBackboneModal.defaultOptions,t);o.template&&new a.EVFBackboneModal.View({target:o.template,string:o.variable})},a.EVFBackboneModal.defaultOptions={template:"",variable:{}},a.EVFBackboneModal.View=e.View.extend({tagName:"div",id:"evf-backbone-modal-dialog",_target:undefined,_string:undefined,events:{"click .modal-close":"closeButton","click #btn-ok":"addButton","touchstart #btn-ok":"addButton",keydown:"keyboardActions"},resizeContent:function(){var e=a(".evf-backbone-modal-content").find("article"),t=.75*a(window).height();e.css({"max-height":t+"px"})},initialize:function(e){var t=this;this._target=e.target,this._string=e.string,o.bindAll(this,"render"),this.render(),a(window).resize(function(){t.resizeContent()})},render:function(){var e=wp.template(this._target);this.$el.append(e(this._string)),a(document.body).css({overflow:"hidden"}).append(this.$el),this.resizeContent(),this.$(".evf-backbone-modal-content").attr("tabindex","0").focus(),a(document.body).trigger("init_tooltips"),a(document.body).trigger("evf_backbone_modal_loaded",this._target)},closeButton:function(e){e.preventDefault(),a(document.body).trigger("evf_backbone_modal_before_remove",this._target),this.undelegateEvents(),a(document).off("focusin"),a(document.body).css({overflow:"auto"}),this.remove(),a(document.body).trigger("evf_backbone_modal_removed",this._target)},addButton:function(e){a(document.body).trigger("evf_backbone_modal_response",[this._target,this.getFormData()]);var t={action:"everest_forms_new_form",security:n.evf_new_form_nonce,form_name:a("#evf-modal-form-name").val()};a.ajax({url:n.ajax_url,data:t,type:"POST",beforeSend:function(){},success:function(e){var t="",o="success";"undefined"!=typeof e.success?0<e.data.id?(t="Form successfully created. Redirecting....",setTimeout(function(){window.location=e.data.redirect},1e3)):(t="Unknown error ! Could not create a form",o="error"):(o="error",t="Unknown error ! Could not create a form");var n='<div id="message" class="notice notice-'+o+' is-dismissible"><p>'+t+"</p></div>";a("#evf-backbone-modal-dialog").find("#message").remove(),a("#evf-backbone-modal-dialog").find("article").append(n)}})},getFormData:function(){var o={};return a(document.body).trigger("evf_backbone_modal_before_update",this._target),a.each(a("form",this.$el).serializeArray(),function(e,t){-1!==t.name.indexOf("[]")?(t.name=t.name.replace("[]",""),o[t.name]=a.makeArray(o[t.name]),o[t.name].push(t.value)):o[t.name]=t.value}),o},keyboardActions:function(e){var t=e.keyCode||e.which;13!==t||e.target.tagName&&("input"===e.target.tagName.toLowerCase()||"textarea"===e.target.tagName.toLowerCase())||this.addButton(e),27===t&&this.closeButton(e)}}),a("body").on("click",".evf-add-new",function(e){return a(this).EVFBackboneModal({template:"evf-add-new-form",variable:{test:"tet"}}),!1})}(jQuery,Backbone,_,window.evf_form_modal_data);